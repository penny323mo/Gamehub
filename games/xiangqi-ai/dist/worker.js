(function(){"use strict";function k(t){return t?t/10|0:0}function P(t){return t?t%10:0}function N(t,e){return t*10+e}function T(t){return t===1?2:1}function A(t,e){return t*9+e}function v(t){return t/9|0}function C(t){return t%9}function x(t,e){return t>=0&&t<10&&e>=0&&e<9}function kt(){const t=new Int8Array(90),e=[5,4,3,2,1,2,3,4,5];for(let n=0;n<9;n++)t[A(0,n)]=N(2,e[n]),t[A(9,n)]=N(1,e[n]);t[A(2,1)]=N(2,6),t[A(2,7)]=N(2,6),t[A(7,1)]=N(1,6),t[A(7,7)]=N(1,6);for(let n=0;n<9;n+=2)t[A(3,n)]=N(2,7),t[A(6,n)]=N(1,7);return t}function gt(t,e,n){return t<<15|e<<8|n&255}function H(t,e){const n=N(e,1);for(let o=0;o<90;o++)if(t[o]===n)return o;return-1}function Dt(t,e,n,o,r){if(e!==o&&n!==r)return!1;if(e===o){const s=Math.min(n,r),f=Math.max(n,r);for(let c=s+1;c<f;c++)if(t[A(e,c)])return!1}else{const s=Math.min(e,o),f=Math.max(e,o);for(let c=s+1;c<f;c++)if(t[A(c,n)])return!1}return!0}function Bt(t,e,n,o,r){if(e!==o&&n!==r)return!1;let s=0;if(e===o){const f=Math.min(n,r),c=Math.max(n,r);for(let i=f+1;i<c;i++)t[A(e,i)]&&s++}else{const f=Math.min(e,o),c=Math.max(e,o);for(let i=f+1;i<c;i++)t[A(i,n)]&&s++}return s===1}const W=[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],Z=[[-1,0],[-1,0],[0,-1],[0,1],[0,-1],[0,1],[1,0],[1,0]];function Ft(t,e,n,o,r){for(let s=0;s<8;s++)if(e+W[s][0]===o&&n+W[s][1]===r&&t[A(e+Z[s][0],n+Z[s][1])]===0)return!0;return!1}function pt(t,e,n,o,r){if(r===1){if(t-1===n&&e===o||t<=4&&t===n&&Math.abs(e-o)===1)return!0}else if(t+1===n&&e===o||t>=5&&t===n&&Math.abs(e-o)===1)return!0;return!1}function It(t){const e=H(t,1),n=H(t,2);if(e<0||n<0)return!1;const o=C(e),r=C(n);if(o!==r)return!1;for(let s=v(n)+1;s<v(e);s++)if(t[A(s,o)])return!1;return!0}function G(t,e){const n=H(t,e);if(n<0)return!0;const o=v(n),r=C(n),s=T(e);for(let f=0;f<90;f++){const c=t[f];if(!c||k(c)!==s)continue;const i=v(f),u=C(f),l=P(c);if(l===5&&Dt(t,i,u,o,r)||l===6&&Bt(t,i,u,o,r)||l===4&&Ft(t,i,u,o,r)||l===7&&pt(i,u,o,r,s))return!0;if(l===1&&u===r){let a=!1;const M=Math.min(i,o),K=Math.max(i,o);for(let O=M+1;O<K;O++)if(t[A(O,u)]){a=!0;break}if(!a)return!0}}return!1}function E(t,e,n,o,r,s,f){if(!x(r,s))return;const c=A(r,s),i=t[c];i&&k(i)===e||f.push(gt(A(n,o),c,i))}function Pt(t,e,n,o,r){const s=[[-1,0],[1,0],[0,-1],[0,1]],f=e===1?7:0,c=e===1?9:2;for(const[i,u]of s){const l=n+i,a=o+u;l<f||l>c||a<3||a>5||E(t,e,n,o,l,a,r)}}function Ct(t,e,n,o,r){const s=[[-1,-1],[-1,1],[1,-1],[1,1]],f=e===1?7:0,c=e===1?9:2;for(const[i,u]of s){const l=n+i,a=o+u;l<f||l>c||a<3||a>5||E(t,e,n,o,l,a,r)}}function Kt(t,e,n,o,r){const s=[[-2,-2],[-2,2],[2,-2],[2,2]],f=[[-1,-1],[-1,1],[1,-1],[1,1]];for(let c=0;c<4;c++){const i=n+s[c][0],u=o+s[c][1];x(i,u)&&(e===1&&i<5||e===2&&i>4||t[A(n+f[c][0],o+f[c][1])]||E(t,e,n,o,i,u,r))}}function vt(t,e,n,o,r){for(let s=0;s<8;s++){const f=n+W[s][0],c=o+W[s][1];x(f,c)&&(t[A(n+Z[s][0],o+Z[s][1])]||E(t,e,n,o,f,c,r))}}function ht(t,e,n,o,r){const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[f,c]of s)for(let i=1;i<10;i++){const u=n+f*i,l=o+c*i;if(!x(u,l))break;const a=t[A(u,l)];if(a){k(a)!==e&&E(t,e,n,o,u,l,r);break}E(t,e,n,o,u,l,r)}}function Lt(t,e,n,o,r){const s=[[-1,0],[1,0],[0,-1],[0,1]];for(const[f,c]of s){let i=!1;for(let u=1;u<10;u++){const l=n+f*u,a=o+c*u;if(!x(l,a))break;const M=t[A(l,a)];if(i){if(M){k(M)!==e&&E(t,e,n,o,l,a,r);break}}else{if(M){i=!0;continue}E(t,e,n,o,l,a,r)}}}}function Tt(t,e,n,o,r){e===1?(E(t,e,n,o,n-1,o,r),n<=4&&(E(t,e,n,o,n,o-1,r),E(t,e,n,o,n,o+1,r))):(E(t,e,n,o,n+1,o,r),n>=5&&(E(t,e,n,o,n,o-1,r),E(t,e,n,o,n,o+1,r)))}function xt(t,e){const n=[];for(let o=0;o<90;o++){const r=t[o];if(!r||k(r)!==e)continue;const s=v(o),f=C(o);switch(P(r)){case 1:Pt(t,e,s,f,n);break;case 2:Ct(t,e,s,f,n);break;case 3:Kt(t,e,s,f,n);break;case 4:vt(t,e,s,f,n);break;case 5:ht(t,e,s,f,n);break;case 6:Lt(t,e,s,f,n);break;case 7:Tt(t,e,s,f,n);break}}return n}function V(t,e){const n=xt(t,e),o=[];for(const r of n){const s=r>>>15,f=r>>>8&127,c=t[f];t[f]=t[s],t[s]=0;const i=!G(t,e)&&!It(t);t[s]=t[f],t[f]=c,i&&o.push(r)}return o}function z(t,e){const n=e>>>15,o=e>>>8&127;t[o]=t[n],t[n]=0}function U(t,e){const n=e>>>15,o=e>>>8&127,r=e&255;t[n]=t[o],t[o]=r}const S=new Int16Array(8);S[1]=1e4,S[2]=120,S[3]=120,S[4]=270,S[5]=600,S[6]=285,S[7]=30;const _t=new Int16Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,20,30,40,45,40,30,20,10,20,40,60,70,80,70,60,40,20,10,30,50,60,70,60,50,30,10,0,0,20,30,40,30,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),yt=new Int16Array([-10,0,5,10,10,10,5,0,-10,-5,0,10,15,15,15,10,0,-5,0,10,15,20,20,20,15,10,0,0,10,20,25,25,25,20,10,0,0,10,20,25,30,25,20,10,0,0,10,20,25,25,25,20,10,0,0,10,15,20,20,20,15,10,0,-5,0,10,15,15,15,10,0,-5,-10,0,5,10,10,10,5,0,-10,-15,-5,0,5,5,5,0,-5,-15]),wt=new Int16Array([0,0,10,15,15,15,10,0,0,0,0,5,10,10,10,5,0,0,0,5,10,15,15,15,10,5,0,0,5,10,12,12,12,10,5,0,0,0,5,8,8,8,5,0,0,0,0,5,8,8,8,5,0,0,0,5,10,12,12,12,10,5,0,5,10,15,20,20,20,15,10,5,5,10,15,20,25,20,15,10,5,0,5,10,15,15,15,10,5,0]),Ht=new Int16Array([5,10,10,15,15,15,10,10,5,5,10,15,20,20,20,15,10,5,5,10,15,20,20,20,15,10,5,10,15,20,25,25,25,20,15,10,10,15,20,25,25,25,20,15,10,10,15,20,25,25,25,20,15,10,5,10,15,20,20,20,15,10,5,0,5,10,15,15,15,10,5,0,0,5,10,15,15,15,10,5,0,0,0,5,10,10,10,5,0,0]),_={};_[7]=_t,_[4]=yt,_[6]=wt,_[5]=Ht;function ot(t,e,n){const o=_[t];return o?o[e*9+n]:0}const R=99999,h=9e4;function Wt(t,e){let n=0;for(let o=0;o<90;o++){const r=t[o];if(!r)continue;const s=k(r),f=P(r),c=v(o),i=C(o);let u=S[f];s===1?u+=ot(f,c,i):u+=ot(f,9-c,i),n+=s===1?u:-u}G(t,1)&&(n-=80),G(t,2)&&(n+=80);for(const o of[1,2]){const r=H(t,o);if(r<0){n+=o===1?-h:h;continue}const s=C(r);let f=!1;for(let c=0;c<10;c++){const i=t[c*9+s];if(i&&k(i)===o&&(P(i)===5||P(i)===6)){f=!0;break}}f||(n+=o===1?-15:15)}return e===1?n:-n}let J=0x123456789ABCDEF0n,Q=0xFEDCBA9876543210n;const rt=0xFFFFFFFFFFFFFFFFn;function st(){let t=J,e=Q;return J=e,t^=t<<23n&rt,t^=t>>17n,t^=e,t^=e>>26n,Q=t,t+e&rt}const Y=new Map;let $=0n;function Zt(){J=0x123456789ABCDEF0n,Q=0xFEDCBA9876543210n;for(const t of[1,2])for(let e=1;e<=7;e++){const n=N(t,e),o=new Array(90);for(let r=0;r<90;r++)o[r]=st();Y.set(n,o)}$=st()}function ft(t,e){let n=0n;for(let o=0;o<90;o++){const r=t[o];if(r){const s=Y.get(r);s&&(n^=s[o])}}return e===2&&(n^=$),n}function ct(t,e,n,o,r){const s=Y.get(o);if(t^=s[e],t^=s[n],r){const f=Y.get(r);f&&(t^=f[n])}return t^=$,t}Zt();const b=typeof performance<"u"&&typeof performance.now=="function"?performance.now.bind(performance):Date.now,d=0,it=1,ut=2;let g=new Map;const Gt=1<<20,Vt=4;let y=0;function lt(t,e,n,o){const r=g.get(t);if(!r)return null;if(r.gen=y,r.depth>=e){if(r.flag===d)return{score:r.score,bestMove:r.bestMove};if(r.flag===it&&r.score>=o)return{score:r.score,bestMove:r.bestMove};if(r.flag===ut&&r.score<=n)return{score:r.score,bestMove:r.bestMove}}return{score:null,bestMove:r.bestMove}}function at(t,e,n,o,r){const s=g.get(t);if(s&&s.depth>e){s.gen=y;return}if(g.set(t,{depth:e,score:n,flag:o,bestMove:r,gen:y}),g.size>Gt)for(const[f,c]of g)y-c.gen>Vt&&g.delete(f)}function zt(t,e,n,o){let r=0;n&&e===n&&(r+=1e5),X[o]&&X[o]===e&&(r+=9e4);const s=e&255;s&&(r+=S[P(s)]*10-S[P(t[e>>>15])]);const f=j.get(e);return f&&(r+=f),r}function tt(t,e,n,o){const r=e.map(s=>({m:s,s:zt(t,s,n,o||0)}));return r.sort((s,f)=>f.s-s.s),r.map(s=>s.m)}let nt=0,At=0,et=0,D=!1,X=[],j=new Map;function Ot(t,e,n,o,r,s){if((++nt&4095)===0&&b()-et>=At)return D=!0,0;let f=0;const c=lt(s,n,o,r);if(c){if(c.score!==null)return c.score;f=c.bestMove||0}if(n<=0)return Et(t,e,o,r,4);const i=V(t,e);if(i.length===0)return G(t,e)?-h+(100-n):0;const u=tt(t,i,f,n);let l=-R,a=u[0];const M=o;for(const O of u){const m=O>>>15,B=O>>>8&127,F=t[m],p=t[B],L=ct(s,m,B,F,p);z(t,O);const I=-Ot(t,T(e),n-1,-r,-o,L);if(U(t,O),D)return o;if(I>l&&(l=I,a=O),I>o&&(o=I),o>=r)return(O&255)===0&&(X[n]=O,j.set(O,(j.get(O)||0)+n*n)),at(s,n,l,it,a),l}const K=l<=M?ut:d;return at(s,n,l,K,a),l}function Et(t,e,n,o,r){const s=Wt(t,e);if(s>=o)return o;if(s>n&&(n=s),r<=0)return n;const c=V(t,e).filter(u=>(u&255)!==0),i=tt(t,c,0);for(const u of i){z(t,u);const l=-Et(t,T(e),-o,-n,r-1);if(U(t,u),D)return 0;if(l>=o)return o;l>n&&(n=l)}return n}function Ut(t,e,n,o){const r=[],s=new Set;let f=e,c=n;for(let i=0;i<o&&!s.has(c);i++){s.add(c);const u=g.get(c);if(!u||u.flag!==d||!u.bestMove)break;const l=u.bestMove,a=l>>>15,M=t[a];if(!M||k(M)!==f)break;r.push(l),z(t,l),f=T(f),c=ft(t,f)}for(let i=r.length-1;i>=0;i--)U(t,r[i]);return r}const Mt=50,Yt=2;function Xt(t,e,n,o){const r=tt(t,e,o||n),s=n||o;if(s){const f=r.indexOf(s);f>0&&r.splice(f,1),f!==0&&r.unshift(s)}return r}function jt(t,e,n){et=b(),At=n,D=!1,nt=0,y++,X=[],j.clear();let o=0,r=-R,s=0;const f=ft(t,e);for(let u=1;u<=40;u++){const l=V(t,e);if(l.length===0)break;if(l.length===1){o=l[0],s=1;break}const a=lt(f,0,-R,R),M=a?a.bestMove:0,K=Xt(t,l,o,M);let O,m;u>=3&&r>-h+200&&r<h-200?(O=r-Mt,m=r+Mt):(O=-R,m=R);let B=0,F=0,p=-R,L=!0;for(;;){F=0,p=-R;let I=O;for(const w of K){const Nt=w>>>15,St=w>>>8&127,tn=t[Nt],nn=t[St],en=ct(f,Nt,St,tn,nn);z(t,w);const q=-Ot(t,T(e),u-1,-m,-I,en);if(U(t,w),D)break;q>p&&(p=q,F=w),q>I&&(I=q)}if(D){L=!0;break}if(p<=O)O=-R,B++;else if(p>=m)m=R,B++;else{L=!1;break}if(B>Yt&&(O=-R,m=R),D){L=!0;break}}if(D||L||(o=F,r=p,s=u,r>=h-100))break}const c=g.get(f);c&&c.depth<s&&(s=c.depth);const i=Ut(t,e,f,s);return{move:o,score:r,depth:s,nodes:nt,timeMs:Math.round(b()-et),pv:i}}function Rt(t){return Array.from(t).join(",")}function qt(t,e,n,o){const r=t*9+e,s=n*9+o;return{from:r,to:s}}function Jt(t,e,n){for(const o of t){const r=o>>>15,s=o>>>8&127;if(r===e&&s===n)return o}return null}const mt={};(function(){const e=kt();e[A(7,4)]=e[A(7,1)],e[A(7,1)]=0;const n=Rt(e);mt[n]=[[0,1,2,2],[0,7,2,6]]})();function Qt(t){return t==="easy"||t==="normal"||t==="hard"||t==="extreme"?t:"normal"}function $t(t){return t==="easy"?{BOOK_PLIES:4,randomness:.45}:t==="hard"?{BOOK_PLIES:12,randomness:.08}:t==="extreme"?{BOOK_PLIES:16,randomness:.02}:{BOOK_PLIES:8,randomness:.2}}function bt(t){let e=0;for(let n=0;n<t.length;n++)t[n]!==0&&e++;return 32-e}function dt(t,e,n){if(e!==2)return null;const{BOOK_PLIES:o,randomness:r}=$t(n);if(bt(t)>o)return null;const f=Rt(t),c=mt[f];if(!c||!c.length)return null;const i=V(t,2),u=[];for(const l of c){const[a,M,K,O]=l,{from:m,to:B}=qt(a,M,K,O),F=Jt(i,m,B);F!==null&&u.push(F)}return u.length?Math.random()>r?u[0]:u[Math.floor(Math.random()*u.length)]:null}self.onmessage=function(t){const{board:e,side:n,timeLimitMs:o,difficulty:r}=t.data,s=Qt(r),f=new Int8Array(90);for(let l=0;l<90;l++)f[l]=e[l];const c=dt(f,n,s);if(c){self.postMessage({move:c,score:0,depth:0,nodes:0,timeMs:0,pv:[c]});return}let i=o;s==="easy"?i=Math.max(120,Math.floor(o*.35)):s==="normal"?i=Math.max(120,Math.floor(o*.6)):s==="hard"?i=o:s==="extreme"&&(i=Math.min(5e3,Math.floor(o*1.8)));const u=jt(f,n,i);self.postMessage({move:u.move,score:u.score,depth:u.depth,nodes:u.nodes,timeMs:u.timeMs,pv:u.pv||[]})}})();
